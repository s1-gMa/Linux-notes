/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var T=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var G=(a,s)=>{for(var t in s)T(a,t,{get:s[t],enumerable:!0})},Y=(a,s,t,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let e of K(s))!U.call(a,e)&&e!==t&&T(a,e,{get:()=>s[e],enumerable:!(n=j(s,e))||n.enumerable});return a};var J=a=>Y(T({},"__esModule",{value:!0}),a);var X={};G(X,{default:()=>I});module.exports=J(X);var m=require("obsidian");var k={defaultCollapsed:!1,collapseIcon:"\u25BC",expandIcon:"\u25B6",enableHorizontalScroll:!0,collapsedLines:0,buttonAlignment:"left",transparentButton:!1};var b=require("@codemirror/view"),H=require("@codemirror/language"),y=require("@codemirror/state"),V=require("obsidian"),x=y.StateEffect.define(),S=class extends b.WidgetType{constructor(t,n,e,o,i){super();this.startPos=t;this.endPos=n;this.settings=e;this.foldField=o;this.app=i}static getFrontmatterCodeBlockState(t){var i;let n=t.workspace.getActiveViewOfType(V.MarkdownView);if(!(n!=null&&n.file))return null;let e=t.metadataCache.getFileCache(n.file);if(!((i=e==null?void 0:e.frontmatter)!=null&&i["code-blocks"]))return null;let o=e.frontmatter["code-blocks"].toLowerCase();return o==="collapsed"?!0:o==="expanded"?!1:null}getBlockId(){var n;let t=(n=this.app.workspace.getActiveViewOfType(V.MarkdownView))==null?void 0:n.file;return`${(t==null?void 0:t.path)||""}-${this.startPos}-${this.endPos}`}initializeCodeBlock(t){let n=this.getBlockId();if(S.initializedBlocks.has(n))return;S.initializedBlocks.add(n);let e=S.getFrontmatterCodeBlockState(this.app);if(e!==null?e:this.settings.defaultCollapsed){let i=!1;t.state.field(this.foldField).between(this.startPos,this.endPos,()=>{i=!0}),i||requestAnimationFrame(()=>{t.dispatch({effects:x.of({from:this.startPos,to:this.endPos,defaultState:!0})})})}}toDOM(t){let n=document.createElement("div");n.className="code-block-toggle";let e=!1;return t.state.field(this.foldField).between(this.startPos,this.endPos,()=>{e=!0}),this.initializeCodeBlock(t),n.innerHTML=e?this.settings.expandIcon:this.settings.collapseIcon,n.setAttribute("aria-label",e?"Expand code block":"Collapse code block"),n.onclick=o=>{o.preventDefault(),o.stopPropagation(),t.dispatch({effects:x.of({from:this.startPos,to:this.endPos,defaultState:!e})})},n}static clearInitializedBlocks(){S.initializedBlocks.clear()}},v=S;v.initializedBlocks=new Set;var Q=a=>y.StateField.define({create(){return b.Decoration.none},update(s,t){s=s.map(t.changes);for(let n of t.effects)if(n.is(x)){let{from:e,to:o,defaultState:i}=n.value,u=!1;if(s.between(e,o,()=>{u=!0}),!(i!==void 0?i:!u))s=s.update({filter:(c,r)=>c!==e||r!==o});else if(!u){let c=e,r=o,d=b.Decoration.replace({block:!0,inclusive:!0,widget:new class extends b.WidgetType{toDOM(p){let g=document.createElement("div");g.className="code-block-folded",g.style.setProperty("--collapsed-lines",a.collapsedLines.toString());let w=document.createElement("div");w.className="folded-content";let f=p.state.doc.sliceString(c,r).split(`
`),C=f[0].match(/^```(\w+)?/),E=C&&C[1]?C[1]:"",h=f.slice(1);h.length>0&&h[h.length-1].trim().startsWith("```")&&(h=h.slice(0,-1));let $=h.slice(0,a.collapsedLines).join(`
`),L=document.createElement("pre"),P=document.createElement("code");E&&(P.className=`language-${E}`,L.className=`language-${E}`),P.textContent=$,L.appendChild(P),w.appendChild(L),requestAnimationFrame(()=>{typeof Prism!="undefined"&&E&&Prism.highlightElement(P)});let B=document.createElement("div");return B.className="code-block-toggle",B.textContent=a.expandIcon,B.onclick=F=>{F.preventDefault(),F.stopPropagation(),p.dispatch({effects:x.of({from:c,to:r,defaultState:!1})})},g.appendChild(B),g.appendChild(w),g}}});s=s.update({add:[d.range(e,o)]})}}return s},provide:s=>b.EditorView.decorations.from(s)}),O=y.StateField.define({create(a){return z(a)},update(a,s){return z(s.state)}});function z(a){let s=[];return(0,H.syntaxTree)(a).iterate({enter:t=>{let n=t.type.name;if(n.includes("HyperMD-codeblock-begin")){let e=document.querySelector(`.${n}`);e&&e.parentElement&&e.parentElement.classList.add("ccb-editor-codeblock");let o=a.doc.lineAt(t.from);if(o.text.trim().startsWith("```")){let i=!1;for(let u=o.number;u<=a.doc.lines;u++){let l=a.doc.line(u);if(u!==o.number&&l.text.trim().startsWith("```")){s.push({startPos:o.from,endPos:l.to}),i=!0;break}}i||s.push({startPos:o.from,endPos:a.doc.line(a.doc.lines).to})}}}}),s}function N(a,s,t,n){let e=[];return a.field(O).forEach(i=>{let u=b.Decoration.widget({widget:new v(i.startPos,i.endPos,s,t,n),side:-1});e.push(u.range(i.startPos))}),b.Decoration.set(e,!0)}function R(a,s){let t=Q(a),n=y.StateField.define({create(e){return N(e,a,t,s)},update(e,o){return N(o.state,a,t,s)},provide(e){return b.EditorView.decorations.from(e)}});return[O,t,n]}var D=require("obsidian");function q(a,s){function t(){var d;let l=a.workspace.getActiveViewOfType(D.MarkdownView);if(!(l!=null&&l.file))return null;let c=a.metadataCache.getFileCache(l.file);if(!((d=c==null?void 0:c.frontmatter)!=null&&d["code-blocks"]))return null;let r=c.frontmatter["code-blocks"].toLowerCase();return r==="collapsed"?!0:r==="expanded"?!1:null}function n(){let l=document.createElement("div");l.className="code-block-toggle",l.textContent=s.collapseIcon,l.setAttribute("role","button"),l.setAttribute("tabindex","0"),l.setAttribute("aria-label","Toggle code block visibility");let c=r=>{r.preventDefault();let d=r.target.closest("pre");if(!d)return;d.classList.toggle("collapsed"),e(d,!0);let p=d.classList.contains("collapsed");l.textContent=p?s.expandIcon:s.collapseIcon,l.setAttribute("aria-expanded",(!p).toString()),a.workspace.requestSaveLayout()};return l.addEventListener("click",c),l.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),c(r))}),l}function e(l,c=!1){var C;let r=l.classList.contains("collapsed"),d=a.workspace.getActiveViewOfType(D.MarkdownView);if(!((C=d==null?void 0:d.previewMode)!=null&&C.containerEl))return;let p=d.previewMode.containerEl,g=l.getBoundingClientRect(),w=p.scrollTop,A=g.top+w,f=l.nextElementSibling;for(;f&&!(f instanceof HTMLPreElement);)f instanceof HTMLElement&&(r?(f.classList.add("element-hidden"),f.classList.remove("element-visible","element-spacing")):(f.classList.remove("element-hidden"),f.classList.add("element-visible"))),f=f.nextElementSibling;l.offsetHeight,(async()=>{window.dispatchEvent(new Event("resize")),await new Promise(h=>requestAnimationFrame(h));let E=p.scrollTop;p.scrollTop=Math.max(0,p.scrollHeight-p.clientHeight),await new Promise(h=>requestAnimationFrame(h)),p.scrollTop=E,window.dispatchEvent(new Event("resize")),await new Promise(h=>setTimeout(h,50)),window.dispatchEvent(new Event("resize"))})()}function o(l){document.documentElement.style.setProperty("--collapsed-lines",s.collapsedLines.toString());let c=n();l.insertBefore(c,l.firstChild);let r=t();(r!==null?r:s.defaultCollapsed)&&(l.classList.add("collapsed"),c.textContent=s.expandIcon,e(l,!0))}function i(l){l.querySelectorAll("pre:not(.has-collapse-button)").forEach(c=>{if(!(c instanceof HTMLElement))return;c.classList.add("has-collapse-button","ccb-code-block");let r=c.querySelector("code");r&&r.classList.add("ccb-hide-vertical-scrollbar"),o(c)})}function u(l){return new MutationObserver(c=>{c.forEach(r=>{r.type==="childList"&&l(r.target)})})}return{processNewCodeBlocks:i,setupContentObserver:u}}var I=class extends m.Plugin{async onload(){await this.loadSettings(),this.updateScrollSetting(),this.updateButtonAlignment(),this.updateButtonTransparency(),document.documentElement.style.setProperty("--collapsed-lines",this.settings.collapsedLines.toString());let t=R(this.settings,this.app);this.registerEditorExtension(t),this.addCommand({id:"toggle-code-block-at-cursor",name:"Toggle code block containing cursor",editorCheckCallback:(n,e,o)=>n?e.cm!=null:(this.toggleCodeBlockAtCursor(e),!0),hotkeys:[{modifiers:["Mod","Shift"],key:"K"}]}),this.registerEvent(this.app.workspace.on("file-open",()=>{v.clearInitializedBlocks()})),this.readViewAPI=q(this.app,this.settings),this.contentObserver=this.readViewAPI.setupContentObserver(this.readViewAPI.processNewCodeBlocks),this.registerMarkdownPostProcessor(n=>{this.readViewAPI.processNewCodeBlocks(n),this.contentObserver.observe(n,{childList:!0,subtree:!0})}),this.addSettingTab(new M(this.app,this))}updateScrollSetting(){document.body.setAttribute("data-ccb-horizontal-scroll",this.settings.enableHorizontalScroll.toString())}updateButtonAlignment(){document.body.setAttribute("data-button-alignment",this.settings.buttonAlignment)}updateButtonTransparency(){document.body.setAttribute("data-transparent-button",this.settings.transparentButton.toString())}toggleCodeBlockAtCursor(t){let n=t.cm;if(!n)return;let e=n.state,o=e.selection.main.head,i=e.doc,u=i.lineAt(o),l=-1,c=-1,r=null,d=null;if(u.text.trim().startsWith("```")){r=u;for(let p=u.number+1;p<=i.lines;p++){let g=i.line(p);if(g.text.trim().startsWith("```")){d=g;break}}d&&(l=r.from,c=d.to)}else for(let p=u.number-1;p>=1;p--){let g=i.line(p);if(g.text.trim().startsWith("```")){r=g;for(let w=p+1;w<=i.lines;w++){let A=i.line(w);if(A.text.trim().startsWith("```")){d=A;break}}if(d&&o>=r.from&&o<=d.to){l=r.from,c=d.to;break}else r=null,d=null}}l!==-1&&c!==-1&&n.dispatch({effects:x.of({from:l,to:c})})}sanitizeIcon(t){let n=t.trim();return n.length<=2||this.app.customIcons&&this.app.customIcons.exists(n)?n:k.collapseIcon}async loadSettings(){var n,e;let t=await this.loadData();this.settings={...k,...t,collapseIcon:this.sanitizeIcon((n=t==null?void 0:t.collapseIcon)!=null?n:k.collapseIcon),expandIcon:this.sanitizeIcon((e=t==null?void 0:t.expandIcon)!=null?e:k.expandIcon)}}async saveSettings(){this.settings.collapseIcon=this.sanitizeIcon(this.settings.collapseIcon),this.settings.expandIcon=this.sanitizeIcon(this.settings.expandIcon),await this.saveData(this.settings)}onunload(){var t;(t=this.contentObserver)==null||t.disconnect(),document.body.removeAttribute("data-ccb-horizontal-scroll"),document.body.removeAttribute("data-button-alignment"),document.body.removeAttribute("data-transparent-button")}},M=class extends m.PluginSettingTab{constructor(t,n){super(t,n);this.app=t,this.plugin=n}display(){let{containerEl:t}=this;t.empty(),new m.Setting(t).setName("Default collapsed state").setDesc("Should code blocks be collapsed by default?").addToggle(e=>e.setValue(this.plugin.settings.defaultCollapsed).onChange(async o=>{this.plugin.settings.defaultCollapsed=o,await this.plugin.saveSettings()})),new m.Setting(t).setName("Collapse icon").setDesc("Icon to show when code block is expanded (single character or emoji only)").addText(e=>e.setValue(this.plugin.settings.collapseIcon).onChange(async o=>{let i=o.trim();i.length<=2&&(this.plugin.settings.collapseIcon=i||k.collapseIcon,await this.plugin.saveSettings())})),new m.Setting(t).setName("Expand icon").setDesc("Icon to show when code block is collapsed (single character or emoji only)").addText(e=>e.setValue(this.plugin.settings.expandIcon).onChange(async o=>{let i=o.trim();i.length<=2&&(this.plugin.settings.expandIcon=i||k.expandIcon,await this.plugin.saveSettings())})),new m.Setting(t).setName("Enable horizontal scrolling").setDesc("Allow code blocks to scroll horizontally instead of wrapping text.").addToggle(e=>e.setValue(this.plugin.settings.enableHorizontalScroll).onChange(async o=>{this.plugin.settings.enableHorizontalScroll=o,await this.plugin.saveSettings(),this.plugin.updateScrollSetting()})),new m.Setting(t).setName("Collapsed lines").setDesc("Number of lines visible when code block is collapsed").addText(e=>{e.setValue(this.plugin.settings.collapsedLines.toString()).onChange(async o=>{let i=parseInt(o,10);this.plugin.settings.collapsedLines=isNaN(i)||i<0?0:i,await this.plugin.saveSettings(),document.documentElement.style.setProperty("--collapsed-lines",this.plugin.settings.collapsedLines.toString())})}),new m.Setting(t).setName("Button alignment").setDesc("Align the collapse/expand button to the left or right side of the code block").addDropdown(e=>e.addOption("left","Left").addOption("right","Right").setValue(this.plugin.settings.buttonAlignment).onChange(async o=>{this.plugin.settings.buttonAlignment=o,await this.plugin.saveSettings(),this.plugin.updateButtonAlignment()})),new m.Setting(t).setName("Transparent button").setDesc("Make the collapse/expand button transparent until hovered over").addToggle(e=>e.setValue(this.plugin.settings.transparentButton).onChange(async o=>{this.plugin.settings.transparentButton=o,await this.plugin.saveSettings(),this.plugin.updateButtonTransparency()})),new m.Setting(t).setName("Keyboard shortcut").setDesc("Toggle the code block containing the cursor. Default: Cmd/Ctrl+Shift+K. You can customize this in Settings \u2192 Hotkeys").addButton(e=>e.setButtonText("Open Hotkey Settings").onClick(()=>{var i,u;this.app.setting.openTabById("hotkeys");let o=(u=(i=this.app.setting.activeTab)==null?void 0:i.searchComponent)==null?void 0:u.inputEl;o&&(o.value="Toggle code block containing cursor",o.dispatchEvent(new Event("input")))}))}};

/* nosourcemap */