---
tags:
  - 编译
---
## 2.1 规则 #Makefile

规则是 Makefile 的基本元素,格式为:

    目标(target)... : 依赖(prerequisites)...
        命令(command)

**注**:make 会比较文件时间(例如 `a.c` 与 `a.o`,`test` 与 `a.o`) 判断是否需要重新生成目标:

- 依赖文件比目标文件新
- 目标文件不存在

示例:

    test : a.o b.o
        gcc -o test a.o b.o

    a.o : a.c
        gcc -c -o a.o a.c

    b.o : b.c
        gcc -c -o b.o b.c

## 2.2 常用函数 #Makefile
### 2.2.1foreach

语法:

    $(foreach var, list, text)

含义:*for each var in list, change it to text*
	对 `list` 中的每个元素依次赋给 `var`,再把 `var` 替换到 `text` 中.

示例:

    objs := a.o b.o
    dep_files := $(foreach f, $(objs), .$(f).d)

结果:

	 dep_files  = .a.o.d .b.o.d

### 2.2.2wildcard

语法:

    $(wildcard pattern)

含义:列出匹配 `pattern` 的所有存在文件.

示例:

    src_files := $(wildcard *.c)

结果:

- src_files 中保存当前目录下所有 `.c` 文件的文件名.

## 2.3 语法与通配符

常用通配符和自动变量:

- `%.c` / `%.o`:匹配相同前缀的 `.c` / `.o` 文件
- `$@`:当前规则的目标文件名
- `$<`:第一个依赖文件名
- `$^`:所有依赖文件名

简化前面的示例:

    test : a.o b.o c.o
        gcc -o test $^

    %.o : %.c
        gcc -c -o $@ $<

## 2.4 假想目标 

可以通过 `.PHONY` 声明伪目标,避免和同名文件冲突:

    .PHONY: clean

- 如果当前目录下有一个名为 `clean` 的文件,执行 `make clean` 时,make 会认为目标已经是最新的,不去执行规则.
- 将其声明为 `.PHONY` 后,无论有没有同名文件,命令都会执行.

常见伪目标:`clean`,`all`,`install` 等.

## 2.5 变量:延时变量与即时变量(=,:=,+=) #Makefile
示例:

    A = xxx      # 延时变量(递归展开)
    B = yyy      # 延时变量
    C := zzz     # 即时变量(简单展开,定义时就展开)
    D += uuu     # 追加赋值(类型取决于第一次定义)

区别:

- 延时变量:在"使用时"才展开,可以引用其它尚未定义完全的变量.
- 即时变量:在"定义时"就展开,类似 C 语言中的宏展开.

## 2.6 自动检测头文件是否更改(依赖文件 .*.d) #Makefile

典型结构:

    objs := main.o sub.o

    test : $(objs)
        gcc -o test $^

    dep_files := $(foreach f, $(objs), .$(f).d)
    dep_files := $(wildcard $(dep_files))

    ifneq ($(dep_files),)
    include $(dep_files)
    endif

    %.o : %.c
        gcc -Wp,-MD,.$@.d -c -o $@ $<

    clean:
        rm *.o test -f

    distclean:
        rm $(dep_files) *.o test -f

说明:

- 在编译 `.c` 文件时使用 `-Wp,-MD,.$@.d`,生成依赖文件 `.<目标>.d`.
- 通过 `include` 把这些依赖文件包含进来,就能在头文件变化时自动重新编译相关的 `.o` 文件.

## 2.7 CFLAGS:编译选项与头文件目录 #Makefile

常见用法:

- 1.开启额外的编译检查(例如把 warning 当作 error):

    `CFLAGS += -Werror`

- 2.指定额外的头文件搜索路径:

    `CFLAGS += -Iinclude`
